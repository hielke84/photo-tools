#!/usr/bin/env bash

main() {
  borderColor=white
  borderPercentage=2

  positionalArgs=()
  while [[ $# -gt 0 ]]; do
    case $1 in
      -c)
        borderColor="$2"
        shift 2
        ;;      
      -w)
        borderPercentage="$2"
        shift 2
        ;;        
      -*)
        echo "Unknown option $1"
        echo
        usage
        exit 1
        ;;
      *)
        positionalArgs+=("$1")
        shift
        ;;
    esac
  done
  set -- "${positionalArgs[@]}"

  filepath1="$1"
  filepath2="$2"

  width1=$(magick identify -ping -format '%w' "$filepath1")
  height1=$(magick identify -ping -format '%h' "$filepath1")
  factor1=$(calc "$width1 / $height1")

  width2=$(magick identify -ping -format '%w' "$filepath2")
  height2=$(magick identify -ping -format '%h' "$filepath2")
  factor2=$(calc "$width2 / $height2")

  factorAvg=$(calc "($factor1 + $factor2) / 2")

  if ((width1 < width2)); then
    tileWidth="$width1"
  else
    tileWidth="$width2"
  fi

  if ((height1 < height2)); then
    tileHeight="$height1"
  else
    tileHeight="$height2"
  fi

  geometry="${tileWidth}x${tileHeight}"
  borderFactor=$(calc "$borderPercentage / 100")

  if (( $(calc "$factorAvg > 1") )); then
    # landscape tiles, portrait collage
    tile="1x2"
    borderWidth=$(calcInt "$tileWidth * $borderFactor")
  else
    # portrait tiles, landscape collage
    tile="2x1"
    borderWidth=$(calcInt "$tileHeight * $borderFactor")
  fi

  filename1=$(basename -- "$filepath1")
  filename2=$(basename -- "$filepath2")
  filenameBase1="${filename1%.*}"
  filenameBase2="${filename2%.*}"
  filenameExtension="${filename1##*.}"
  filenameNew="${filenameBase1}+${filenameBase2}${aspectRatio:+_$aspectRatio}.${filenameExtension}"

  magick montage "$filepath1" "$filepath2" \
    -tile "$tile" \
    -geometry "${geometry}>+${borderWidth}+${borderWidth}" \
    -background "${borderColor}" \
    "${filenameNew}"
  echo "Created $filenameNew"
}

calc() {
  result=$(bc -l <<< "$1")
  echo "$result"
}

calcInt() {
  result=$(calc "scale=0; ($1) / 1")
  echo "$result"
}

usage() {
  b=$(tput bold)
  u=$(tput smul)
  n=$(tput sgr0)
 
  echo "${b}${u}COLLAGE$n"
  echo "Combines two images into a collage, separated and surrounded by a border. Portrait images will result in a landscape"
  echo "(horizontal) collage, and landscape images result in a portrait (vertical) collage."
  echo
  echo "Usage: $0 [${b}-c${n} ${u}color${n}] [${b}-w${n} ${u}width${n}] [${b}-r${n} ${u}w${n}x${u}h${n}] ${u}file${n}"
  echo
  echo "Options:"
  echo "  ${b}-c${n} ${u}color${n}"
  echo "        Color of the border."
  echo "        Optional, default: white."
  echo "  ${b}-w${n} ${u}width${n}"
  echo "        Minimal width of the outer border, as a percentage of the original height (in case of a landscape collage)"
  echo "        or the original width (in case of a portrait one)."
  echo "        Optional, default: 2."
}

if ! [ -x "$(command -v magick)" ]; then
  echo "Error: ImageMagick is not installed"
  exit 1
fi

if ! [ -x "$(command -v bc)" ]; then
  echo "Error: bc is not installed"
  exit 1
fi

if [ $# -eq 0 ]; then
  usage
  exit 1
fi

main "$@"
