#!/usr/bin/env bash

main() {
  borderColor=white
  borderPercentage=2

  positionalArgs=()
  while [[ $# -gt 0 ]]; do
    case $1 in
      -c)
        borderColor="$2"
        shift 2
        ;;      
      -w)
        borderPercentage="$2"
        shift 2
        ;;        
      -h)
        orientation="h"
        shift 1
        ;;
      -v)
        orientation="v"
        shift 1
        ;;               
      -*)
        echo "Unknown option $1"
        echo
        usage
        exit 1
        ;;
      *)
        positionalArgs+=("$1")
        shift
        ;;
    esac
  done
  set -- "${positionalArgs[@]}" 

  filepath1="$1"
  filepath2="$2"

  width1=$(magick identify -ping -format '%w' "$filepath1")
  height1=$(magick identify -ping -format '%h' "$filepath1")

  width2=$(magick identify -ping -format '%w' "$filepath2")
  height2=$(magick identify -ping -format '%h' "$filepath2")

  borderFactor=$(calc "$borderPercentage / 100")

  if [ -z "$orientation" ]; then
    factor1=$(calc "$width1 / $height1")
    factor2=$(calc "$width2 / $height2")
    factorAvg=$(calc "($factor1 + $factor2) / 2")
    
    if (( $(calc "$factorAvg > 1") )); then
      # landscape tiles, vertical collage
      orientation="v"
    else 
      # portrait tiles, horizontal collage
      orientation="h"
    fi
  fi
  
  if [ $orientation == "h" ]; then
    if ((height1 < height2)); then
      height="$height1"
    else 
      height="$height2"
    fi
    resize="x${height}"
    append="+append"
    borderWidth=$(calcInt "$height * $borderFactor")
    spacing="${borderWidth}x${height}"
  else
    if ((width1 < width2)); then
      width="$width1"
    else 
      width="$width2"
    fi
    resize="${width}x"
    append="-append"
    borderWidth=$(calcInt "$width * $borderFactor")
    spacing="${width}x${borderWidth}"
  fi

  filename1=$(basename -- "$filepath1")
  filename2=$(basename -- "$filepath2")
  filenameBase1="${filename1%.*}"
  filenameBase2="${filename2%.*}"
  filenameExtension="${filename1##*.}"
  filenameNew="${filenameBase1}+${filenameBase2}_${orientation}.${filenameExtension}"

  magick \
    \( "$filepath1" -resize "${resize}" \) \
    xc:none["$spacing"] \
    \( "$filepath2" -resize "${resize}" \) \
    $append \
    -bordercolor "${borderColor}" \
    -border "${borderWidth}" \
    "${filenameNew}"

  echo "Created $filenameNew"
}

calc() {
  result=$(bc -l <<< "$1")
  echo "$result"
}

calcInt() {
  result=$(calc "scale=0; ($1) / 1")
  echo "$result"
}

usage() {
  b=$(tput bold)
  u=$(tput smul)
  n=$(tput sgr0)
  
  echo "${b}${u}COLLAGE$n"
  echo "Combines two images into a collage, separated and surrounded by a border."
  echo
  echo "Usage: $0 [${b}-c${n} ${u}color${n}] [${b}-w${n} ${u}width${n}] [${b}-r${n} ${u}w${n}x${u}h${n}] ${u}file${n}"
  echo
  echo "Options:"
  echo "  ${b}-h${n}"
  echo "        Make a horizontal collage." 
  echo "  ${b}-v${n}"
  echo "        Make a vertical collage."
  echo 
  echo "  If ${b}-h${n} and ${b}-v${n} are not set, portrait images will result in a horizontal collage, and landscape images in a"
  echo "  vertical one."
  echo   
  echo "  ${b}-c${n} ${u}color${n}"
  echo "        Color of the border."
  echo "        Optional, default: white."
  echo "  ${b}-w${n} ${u}width${n}"
  echo "        Minimal width of the outer border, as a percentage of the original height (in case of a horizontal collage)"
  echo "        or the original width (in case of a vertical one)."
  echo "        Optional, default: 2."
}

if ! [ -x "$(command -v magick)" ]; then
  echo "Error: ImageMagick is not installed"
  exit 1
fi

if ! [ -x "$(command -v bc)" ]; then
  echo "Error: bc is not installed"
  exit 1
fi

if [ $# -eq 0 ]; then
  usage
  exit 1
fi

main "$@"
