#!/usr/bin/env bash

main() {
  borderColor=white
  borderWidth=2

  positionalArgs=()
  while [[ $# -gt 0 ]]; do
    case $1 in
      -c)
        borderColor="$2"
        shift 2
        ;;
      -w)
        borderWidth="$2"
        shift 2
        ;;
      -r)
        aspectRatio="$2"
        shift 2
        ;;        
      -h)
        usage
        exit 0
        ;;
      -*)
        echo "Unknown option $1"
        echo
        usage
        exit 1
        ;;
      *)
        positionalArgs+=("$1")
        shift
        ;;
    esac
  done
  set -- "${positionalArgs[@]}" 

  filepath="$1"

  width=$(magick identify -ping -format '%w' "$filepath")
  height=$(magick identify -ping -format '%h' "$filepath")
  factor=$(calc "$width / $height")

  borderFactor=$(calc "$borderWidth / 100")
  
  x="${aspectRatio%x*}"
  x="${x:-$width}"
  y="${aspectRatio#*x}"
  y="${y:-$height}"
  factorNew=$(calc "$x / $y")

  if (( $(calc "$factorNew / $factor > 1") )); then 
    # new aspect ratio is wider
    heightNew=$(calcInt "$height * (1 + 2 * $borderFactor)")
    widthNew=$(calcInt "$heightNew * $factorNew")
  else 
    # new aspect ratio is taller
    widthNew=$(calcInt "$width * (1 + 2 * $borderFactor)")
    heightNew=$(calcInt "$widthNew / $factorNew")
  fi

  filename=$(basename -- "$filepath")
  filenameBase="${filename%.*}"
  filenameExtension="${filename##*.}"
  filenameNew="${filenameBase}_${aspectRatio}b.${filenameExtension}"

  magick "$filepath" \
    -gravity Center \
    -size "${widthNew}x${heightNew}" \
    "xc:${borderColor}" \
    +swap -composite \
    "$filenameNew"
  echo "Created $filenameNew"
}

calc() {
  result=$(bc -l <<< "$1")
  echo "$result"
}

calcInt() {
  result=$(calc "scale=0; ($1) / 1")
  echo "$result"
}

usage() {
  b=$(tput bold)
  u=$(tput smul)
  n=$(tput sgr0)

  echo "Adds a border to an image, and, optionally, converts the image to a different"
  echo "aspect ratio."
  echo
  echo "${b}${u}Usage:${n} ${b}$(basename "$0")${n} [OPTIONS] FILE"
  echo
  echo "${b}${u}Options:${n}"
  echo "  ${b}-c${n} COLOR"
  echo "        Set color of the border."
  echo "        Default: white."
  echo "  ${b}-w${n} WIDTH"
  echo "        Set minimal width of the border, as a percentage of the original"
  echo "        height (if the new aspect ratio is wider than the original one)"
  echo "        or the original width (if the new aspect ratio is taller than the"
  echo "        original one)."
  echo "        Default: 2."
  echo "  ${b}-r${n} RATIO"
  echo "        Aspect ratio of the new image in the format ${b}w${n}x${b}h${n}, for example: 2x3."
  echo "        Default: unchanged."
}

if ! [ -x "$(command -v magick)" ]; then
  echo "Error: ImageMagick is not installed"
  exit 1
fi

if ! [ -x "$(command -v bc)" ]; then
  echo "Error: bc is not installed"
  exit 1
fi

if [ $# -eq 0 ]; then
  usage
  exit 1
fi

main "$@"
